# Vite Builder Architecture

- [Vite Builder Architecture](#vite-builder-architecture)
  - [Storybook builder interface](#storybook-builder-interface)
    - [1. `start()` is executed by storybook when running in development mode.](#1-start-is-executed-by-storybook-when-running-in-development-mode)
    - [2. `build()` is performed during produciton builds.](#2-build-is-performed-during-produciton-builds)
  - [Plugins](#plugins)
    - [General plugins](#general-plugins)
    - [Framework plugins](#framework-plugins)

## Storybook builder interface

The vite storybook builder interacts directly with storybook through the main entrypoint, `index.ts`. The `index.ts` file exports two important functions which are used by storybook, and two empty arrays, `corePresets` and `previewPresets`, which storybook needs but we don't use. Let's look at the main two functions.

### 1. `start()` is executed by storybook when running in development mode.

**Inputs (from storybook)**

- the dev `server` & `router` for us to hook into
- the `startTime` when the server started booting up (for calculating the time it takes for the preview builder to finish)
- and the user's storybook `options`

**Returns**

- An async `bail` function to close the vite server when storybook shuts down
- An empty `stats` object. This is something webpack-specific that storybook expects, but since we don't have it, we just give an empty object
- The `totalTime` that it took for the vite server to start up

**Other Notes**
We mock out the `/progress` route, because that's a webpack-specific feature which we don't use.

We start up a vite server in a [`middlewareMode`](https://vitejs.dev/config/#server-middlewaremode) that disables vite's own html serving logic but allows it to still process requests for assets, which it then passes on to the express server that storybook itself is running.

We merge our own default vite config with the user's `viteFinal`, allowing them to customize the way that vite runs.

### 2. `build()` is performed during produciton builds.

**Inputs**

- The user's storybook `options`

**Returns**

- A promise that resolves when the build is finished

To build a production bundle, we build up a vite configuration through a combination of our own defaults with the user's `viteFinal` config in their `.storybook/main.js`, and provide that configuration to vite's `build()` function.

## Plugins

Because the existing frameworks and addons provide webpack configurations that storybook uses but which vite doesn't, we need to re-implement some features with vite plugins. Most are used in both development and production. They are added to our vite config in the `pluginConfig()` function in `vite-config.ts`.

### General plugins

- **codeGeneratorPlugin**: Creates several "virtual files" which are dynamically generated by the vite builder, including the main `iframe.html` file that storybook requests for the preview pane. The virtual files we create will be discussed in more detail later.
- **mockCoreJs**: core-js does not work well with vite, because it uses a babel runtime. At least I think that's why we have this. It keeps core-js from being loaded.
- **sourceLoaderPlugin**: `@storybook/source-loader` is primarily a webpack loader used by storybook to sanitize and save the raw source of a story to a string in the story file itself. This string is then used in the storysource panes in the canvas and docs pages. We add this custom vite plugin so that we can use the transformation function from `@storybook/source-loader` directly to transform story files so that they contain the story source information.
- **mdxPlugin**: a wrapper around [vite-plugin-mdx](https://github.com/brillout/vite-plugin-mdx), using the compiler from `@storybook/csf-tools/mdx`.
- **noFouc**: A hopefully-temporary workaround to an issue in some versions of vite, which strip out styles from the `<head>` of an index.html file, causing a flash of unstyled content. This seems to be fixed in recent vite versions, so we should be able to remove it.
- **injectExportOrderPlugin**: Injects `__namedExportsOrder` if it does not already exist, so that the sidebar will show the export order of stories by default.

### Framework plugins

Depending on the framework being used, we also need to add other plugins. These are "soft" peer dependencies, in that we expect the user to have them in their project, but we don't list them as peerDependencies in our package.json, or else every project would require the plugins for every framework, which makes no sense.

- **Vue**: `[@vitejs/plugin-vue`](https://github.com/vitejs/vite/tree/main/packages/plugin-vue) and `vue-docgen`, a custom plugin that uses [vue-docgen-api](https://github.com/vue-styleguidist/vue-styleguidist/tree/master/packages/vue-docgen-api) to add docgen info to `.vue` files.
- **Svelte**: We use [`@sveltejs/vite-plugin-svelte`](https://github.com/sveltejs/vite-plugin-svelte/tree/master/packages/vite-plugin-svelte), but need to add it twice, once for components with HMR enabled, and once for stories with HMR disabled to work around incompatibilities between the HMR systems of Vite and Webpack. We provide the `svelteOptions` from a user's `.storybook/main.js` to this plugin. We also add a custom `svelte/csf-plugin` to provide CSF support via `@storybook/addon-svelte-csf`.
- **React**: We add [`@vitejs/plugin-react`](https://github.com/vitejs/vite/tree/master/packages/plugin-react), again configured to avoid treating story files as HMR boundaries. Depending on the `typescript` options in the user's `main.js`, we will either add [`@joshwooding/vite-plugin-react-docgen-typescript`](https://github.com/joshwooding/vite-plugin-react-docgen-typescript) if we find `typescript` in the `package.json` file in the user's project root, or a custom `react-docgen` plugin ch uses [`react-docgen`](https://github.com/reactjs/react-docgen), and is essentially a reimplementation of [@storybook/babel-plugin-react-docgen](https://github.com/storybookjs/babel-plugin-react-docgen) as a vite plugin.
- **Glimmerx**: Adds [`vite-plugin-glimmerx`](https://github.com/lifeart/vite-plugin-glimmerx).
